# ==============================================================================
# RENDER.YAML - Render Platform Configuration (Docker-based)
# ==============================================================================
# PURPOSE:
#   - Render builds Docker image from your repository
#   - Uses the same Dockerfile that CI tested
#   - Ensures consistency between CI and production
#
# FLOW:
#   1. GitHub Actions runs tests
#   2. If tests pass → push to main
#   3. Render detects push to main
#   4. Render builds Docker image from Dockerfile
#   5. Render deploys the container
#
# DOCUMENTATION:
#   https://render.com/docs/docker
# ==============================================================================

services:
  # Backend API Service (Docker-based)
  - type: web
    name: todo-backend
    runtime: docker
    region: oregon              # Choose: oregon, frankfurt, singapore, ohio
    plan: free                  # Change to 'starter' for production
    
    # Docker configuration
    dockerfilePath: ./docker/Dockerfile.backend
    dockerContext: .
    
    # Runtime settings
    healthCheckPath: /api/health
    numInstances: 1             # Increase for high availability
    
    # Auto-deploy settings
    autoDeploy: true            # Deploy automatically when main branch updates
    
    # Environment variables
    envVars:
      - key: NODE_ENV
        value: production
      - key: MONGODB_URI
        sync: false           # Set in Render dashboard (secret)

# ==============================================================================
# DEPLOYMENT PROCESS:
# 
# 1. You push to GitHub main branch
# 2. GitHub Actions runs tests (CI)
# 3. If tests pass → code is available on main
# 4. Render detects changes on main branch
# 5. Render builds using: npm ci
# 6. Render starts using: npm start
# 7. Render checks /api/health endpoint
# 8. If healthy → deployment succeeds
# 9. Traffic switches to new deployment
# 
# FAILURE MODES:
# 
# - If build fails → deployment aborted, old version keeps running
# - If health check fails → deployment aborted, old version keeps running
# - If app crashes → Render auto-restarts (up to retry limits)
# 
# WHERE TO CHECK LOGS:
# - Render Dashboard → Your Service → Logs tab
# - Build logs show npm ci output
# - Runtime logs show console.log output
# ==============================================================================
